<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========== ACCIÓN DE VENTANA ========== -->
    <record id="action_dgii_ecf_sequence_range_list" model="ir.actions.act_window">
        <field name="name">Rangos de Secuencias e-NCF</field>
        <field name="res_model">dgii.ecf.sequence.range</field>
        <field name="view_mode">list,form,kanban</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                ¡Cree su primer rango de secuencias e-NCF!
            </p>
            <p>
                Los rangos de secuencias se utilizan para generar automáticamente
                los números de comprobantes fiscales electrónicos (e-NCF) según
                la normativa de la DGII de República Dominicana.
            </p>
        </field>
    </record>

    <!-- ========== VISTA DE FORMULARIO ========== -->
    <record id="view_dgii_ecf_sequence_range_form" model="ir.ui.view">
        <field name="name">dgii.ecf.sequence.range.form</field>
        <field name="model">dgii.ecf.sequence.range</field>
        <field name="arch" type="xml">
            <form string="Rango de Secuencias e-NCF">
                <header>
                    <button name="action_activar" string="Activar" type="object"
                            invisible="estado != 'draft'" class="btn-primary" primary="1"/>
                    <button name="action_anular" string="Anular" type="object"
                            invisible="estado in ['agotado', 'vencido', 'anulado']"
                            confirm="¿Está seguro que desea anular este rango?"/>
                    <field name="estado" widget="statusbar"
                           statusbar_visible="draft,activo,agotado,vencido"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="%(action_dgii_ecf_sequence_range_list)d" type="action"
                                class="oe_stat_button" icon="fa-list">
                            <field name="secuencias_disponibles" widget="statinfo"
                                   string="Disponibles"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <label for="name"/>
                        <h1>
                            <field name="name" placeholder="Ej: Rango FCF 001-001 2025"/>
                        </h1>
                    </div>
                    <group>
                        <group string="Información General">
                            <field name="company_id" groups="base.group_multi_company"/>
                            <field name="tipo_ecf"/>
                            <field name="es_electronico"/>
                            <field name="fecha_vencimiento"/>
                        </group>
                        <group string="Estadísticas">
                            <field name="porcentaje_usado" widget="progressbar"/>
                            <field name="dias_para_vencer"
                                   decoration-danger="dias_para_vencer &lt; 7"
                                   decoration-warning="dias_para_vencer &lt; 30 and dias_para_vencer &gt;= 7"/>
                        </group>
                    </group>
                    <group>
                        <group string="Identificación del Emisor">
                            <field name="establecimiento"/>
                            <field name="punto_emision"/>
                        </group>
                        <group string="Rango de Secuencias">
                            <field name="secuencia_desde"/>
                            <field name="secuencia_hasta"/>
                            <field name="secuencia_actual" readonly="1"/>
                        </group>
                    </group>
                    <group string="Diarios Autorizados">
                        <field name="journal_ids" nolabel="1" widget="many2many_tags"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- ========== VISTA DE LISTA ========== -->
    <record id="view_dgii_ecf_sequence_range_tree" model="ir.ui.view">
        <field name="name">dgii.ecf.sequence.range.tree</field>
        <field name="model">dgii.ecf.sequence.range</field>
        <field name="arch" type="xml">
            <list string="Rangos e-NCF"
                  decoration-success="estado == 'activo'"
                  decoration-danger="estado in ['agotado', 'vencido']"
                  decoration-muted="estado == 'anulado'">
                <field name="name"/>
                <field name="tipo_ecf"/>
                <field name="establecimiento"/>
                <field name="punto_emision"/>
                <field name="secuencia_desde"/>
                <field name="secuencia_hasta"/>
                <field name="secuencia_actual"/>
                <field name="secuencias_disponibles"/>
                <field name="porcentaje_usado" widget="progressbar"/>
                <field name="fecha_vencimiento"/>
                <field name="dias_para_vencer"
                       decoration-danger="dias_para_vencer &lt; 7"
                       decoration-warning="dias_para_vencer &lt; 30 and dias_para_vencer &gt;= 7"/>
                <field name="estado" widget="badge"
                       decoration-success="estado == 'activo'"
                       decoration-danger="estado in ['agotado', 'vencido']"
                       decoration-muted="estado == 'anulado'"
                       decoration-info="estado == 'draft'"/>
            </list>
        </field>
    </record>

    <!-- ========== VISTA DE BÚSQUEDA ========== -->
    <!-- Temporalmente comentada - agregar después de instalar el módulo
    <record id="view_dgii_ecf_sequence_range_search" model="ir.ui.view">
        <field name="name">dgii.ecf.sequence.range.search</field>
        <field name="model">dgii.ecf.sequence.range</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="tipo_ecf"/>
                <field name="establecimiento"/>
                <field name="punto_emision"/>
                <filter string="Activos" name="activos" domain="[('estado', '=', 'activo')]"/>
                <filter string="Borradores" name="draft" domain="[('estado', '=', 'draft')]"/>
                <filter string="Agotados" name="agotados" domain="[('estado', '=', 'agotado')]"/>
                <filter string="Vencidos" name="vencidos" domain="[('estado', '=', 'vencido')]"/>
                <group expand="0" string="Agrupar Por">
                    <filter string="Tipo e-CF" name="group_tipo" context="{'group_by': 'tipo_ecf'}"/>
                    <filter string="Estado" name="group_estado" context="{'group_by': 'estado'}"/>
                </group>
            </search>
        </field>
    </record>
    -->

    <!-- ========== VISTA KANBAN ========== -->
    <record id="view_dgii_ecf_sequence_range_kanban" model="ir.ui.view">
        <field name="name">dgii.ecf.sequence.range.kanban</field>
        <field name="model">dgii.ecf.sequence.range</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile">
                <field name="name"/>
                <field name="tipo_ecf"/>
                <field name="estado"/>
                <field name="secuencias_disponibles"/>
                <field name="porcentaje_usado"/>
                <field name="dias_para_vencer"/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                </div>
                                <span t-attf-class="badge rounded-pill
                                    #{record.estado.raw_value === 'activo' ? 'text-bg-success' : ''}
                                    #{record.estado.raw_value === 'draft' ? 'text-bg-info' : ''}
                                    #{record.estado.raw_value === 'agotado' || record.estado.raw_value === 'vencido' ? 'text-bg-danger' : ''}
                                    #{record.estado.raw_value === 'anulado' ? 'text-bg-secondary' : ''}">
                                    <field name="estado"/>
                                </span>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="tipo_ecf"/>
                                <div>Disponibles: <field name="secuencias_disponibles"/></div>
                                <div>Uso: <field name="porcentaje_usado"/>%</div>
                                <div t-if="record.dias_para_vencer.raw_value &lt; 30">
                                    Vence en: <field name="dias_para_vencer"/> días
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ========== MENÚ ========== -->
    <menuitem id="menu_dgii_root"
              name="DGII República Dominicana"
              sequence="100"
              web_icon="odoo_dgii_ecf,static/description/icon.png"/>

    <menuitem id="menu_dgii_config"
              name="Configuración"
              parent="menu_dgii_root"
              sequence="10"/>

    <menuitem id="menu_dgii_ecf_sequence_range"
              name="Rangos e-NCF"
              parent="menu_dgii_config"
              action="action_dgii_ecf_sequence_range_list"
              sequence="10"/>
</odoo>
